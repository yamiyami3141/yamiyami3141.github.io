<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小鳥Lab 予約受付</title>
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="html,css,javascript,小鳥Lab">
    <link rel="icon" href="./img/和logo.ico">
    <meta name="description" content="webサイト体験をもっと楽しく簡単に!!">
    <meta property="og:image" content="./img/和logo.avif">
    <meta property="og:title" content="小鳥Lab">
    <meta property="og:site_name" content="小鳥Lab">
    <meta property="og:description" content="webサイト体験をもっと楽しく簡単に!!">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap');
        [x-cloak] { display: none !important; }
        body { 
            font-family: 'Shippori Mincho', serif; 
            background-color: #f8f7f4;
            background-image: url('https://www.transparenttextures.com/patterns/handmade-paper.png');
            overflow-y: auto;
        }
        .animation-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }
        .writing-vertical { writing-mode: vertical-rl; }
        .animate-in { animation: fade-in 1.2s ease-out forwards; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="select-none bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-rose-50 via-stone-100 to-orange-50 min-h-screen flex flex-col items-center justify-center p-4 text-stone-700 antialiased relative" oncontextmenu="return false;">

    <canvas class="animation-canvas"></canvas>

    <div class="relative z-10 w-full max-w-6xl my-10 bg-white/70 backdrop-blur-3xl border border-white rounded-[2rem] shadow-2xl shadow-rose-200/30 overflow-hidden flex flex-col md:flex-row animate-in" 
        x-data="bookingSystem()">
        
        <div class="md:w-4/12 p-10 flex flex-col justify-between border-b md:border-b-0 md:border-r border-stone-200 relative bg-gradient-to-b from-rose-100/40 to-white/20">
            <div class="absolute top-0 right-4 p-8 opacity-10 text-4xl font-bold writing-vertical tracking-[0.6em] text-stone-900 pointer-events-none">予約受付</div>
            
            <div class="relative">
                <div class="inline-block px-4 py-1.5 bg-rose-500 text-white text-[10px] tracking-[0.2em] mb-6 rounded-full font-sans font-bold shadow-md shadow-rose-200">RESERVATION</div>
                <h2 class="text-3xl font-bold mb-6 tracking-widest text-stone-800 leading-tight">
                    小鳥Lab<br>予約システム
                </h2>
                <div class="space-y-4 text-stone-600 leading-relaxed text-sm">
                    <p class="font-bold">新たな発見、豊かな生活。</p>
                    <p>ITであなたの生活をお手伝いいたします。ご予約は3日後以降より承ります。</p>
                </div>
            </div>
            
            <div class="mt-12 space-y-5">
                <div class="flex items-center gap-4 group">
                    <div class="w-11 h-11 bg-white rounded-2xl flex items-center justify-center shadow-sm text-rose-400 group-hover:bg-rose-500 group-hover:text-white transition-all duration-300">
                        <i data-lucide="map-pin" class="w-5 h-5"></i>
                    </div>
                    <div class="text-sm">
                        <p class="text-[10px] text-stone-400 font-sans tracking-widest uppercase">Location</p>
                        <p class="font-bold tracking-wider">群馬県伊勢崎市エリア</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 group">
                    <div class="w-11 h-11 bg-white rounded-2xl flex items-center justify-center shadow-sm text-teal-500 group-hover:bg-teal-500 group-hover:text-white transition-all duration-300">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                    </div>
                    <div class="text-sm">
                        <p class="text-[10px] text-stone-400 font-sans tracking-widest uppercase">Email Address</p>
                        <p class="font-sans font-medium">kotori.lab.com@gmail.com</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 group">
                    <div class="w-11 h-11 bg-white rounded-2xl flex items-center justify-center shadow-sm text-rose-400 group-hover:bg-violet-400 group-hover:text-white transition-all duration-300">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                    </div>
                    <div class="text-sm">
                        <p class="text-[10px] text-stone-400 font-sans tracking-widest uppercase">Open Hours</p>
                        <p class="font-bold tracking-wider">9:30 - 18:30</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="md:w-8/12 p-6 sm:p-12 relative bg-white/10">
            
            <div x-show="step === 'success'" x-cloak x-transition.opacity
                class="absolute inset-0 bg-white/95 backdrop-blur-xl z-20 flex flex-col items-center justify-center text-center p-4">
                
                <div id="ticketArea" class="bg-white border-2 border-rose-100 p-8 rounded-xl shadow-lg w-full max-w-sm mb-6 relative">
                    <div class="absolute -top-10 -right-10 w-24 h-24 bg-rose-100 rounded-full opacity-50"></div>
                    <div class="absolute -bottom-10 -left-10 w-24 h-24 bg-stone-100 rounded-full opacity-50"></div>

                    <h3 class="text-xl font-bold text-rose-500 mb-6 tracking-widest border-b border-rose-100 pb-2">予約完了票</h3>
                    
                    <div class="text-left space-y-4 text-stone-600 text-sm relative z-10">
                        <div>
                            <p class="text-[10px] text-stone-400 mb-1">ご予約日</p>
                            <p class="font-bold text-lg" x-text="formatDateJP(result.date)"></p>
                        </div>
                        <div>
                            <p class="text-[10px] text-stone-400 mb-1">時間</p>
                            <p class="font-bold text-lg" x-text="result.time + 'から'"></p>
                        </div>
                        <div>
                            <p class="text-[10px] text-stone-400 mb-1">お名前</p>
                            <p class="font-bold text-lg" x-text="formData.name + ' 様'"></p>
                        </div>
                        <div class="pt-2">
                            <p class="text-[10px] text-stone-400 mb-1">予約ID</p>
                            <p class="font-mono text-xs text-stone-400" x-text="result.id"></p>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button @click="downloadTicket" class="px-6 py-3 bg-rose-400 text-white text-xs rounded-full shadow-lg hover:bg-rose-500 transition-colors flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> 画像保存
                    </button>
                    <button @click="location.reload()" class="px-6 py-3 bg-stone-200 text-stone-600 text-xs rounded-full hover:bg-stone-300 transition-colors">
                        戻る
                    </button>
                </div>
            </div>

            <form @submit.prevent="submitReservation" class="space-y-8">
                <div class="space-y-4">
                    <div class="flex items-center gap-2 border-b border-rose-200 pb-2 mb-4">
                        <span class="text-rose-400 font-bold text-xl">01.</span>
                        <h3 class="font-bold text-stone-700">日程と時間の選択</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="space-y-2 relative">
                            <label class="text-[10px] font-bold tracking-[0.2em] text-stone-400">DATE</label>
                            <input type="date" x-model="formData.date" @change="fetchSlots" :min="minDate" required
                                    class="w-full bg-stone-50 border border-stone-200 rounded-lg px-4 py-3 outline-none focus:border-rose-300 cursor-pointer transition-colors">
                        </div>
                        <div class="space-y-2 relative z-10">
                            <label class="text-[10px] font-bold tracking-[0.2em] text-stone-400">TIME</label>
                            <div x-show="isLoadingSlots" class="text-xs text-rose-400 animate-pulse py-3 flex items-center gap-2">
                                <div class="w-2 h-2 bg-rose-400 rounded-full animate-bounce"></div> 状況確認中...
                            </div>
                            
                            <div x-show="!isLoadingSlots" class="grid grid-cols-3 gap-2">
                                <template x-for="time in timeSlots" :key="time">
                                    <button type="button" 
                                        @click="formData.time = time" 
                                        :disabled="bookedSlots.includes(time)" 
                                        :class="{
                                            'bg-rose-500 text-white border-rose-500 shadow-md': formData.time === time,
                                            'bg-stone-100 text-stone-300 cursor-not-allowed border-transparent': bookedSlots.includes(time),
                                            'bg-white text-stone-600 border-stone-200 hover:border-rose-300 hover:text-rose-500': formData.time !== time && !bookedSlots.includes(time)
                                        }"
                                        class="text-xs py-2 rounded border transition-all duration-200 relative overflow-hidden">
                                        <span x-text="time"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6 pt-4">
                    <div class="flex items-center gap-2 border-b border-rose-200 pb-2 mb-4">
                        <span class="text-rose-400 font-bold text-xl">02.</span>
                        <h3 class="font-bold text-stone-700">お客様情報の入力</h3>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold tracking-[0.3em] text-rose-500 flex items-center gap-2"><i data-lucide="user" class="w-3 h-3"></i> お名前</label>
                            <input type="text" x-model="formData.name" required placeholder="小鳥 太郎" class="w-full bg-white/50 border-b-2 border-stone-100 px-2 py-3 outline-none focus:border-rose-400 transition-colors">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold tracking-[0.3em] text-teal-600 flex items-center gap-2"><i data-lucide="phone" class="w-3 h-3"></i> 電話番号</label>
                            <input type="tel" x-model="formData.tel" required placeholder="090-1234-5678" class="w-full bg-white/50 border-b-2 border-stone-100 px-2 py-3 outline-none focus:border-teal-400 transition-colors">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] font-bold tracking-[0.3em] text-stone-400 flex items-center gap-2"><i data-lucide="tag" class="w-3 h-3"></i> 依頼コース</label>
                        <select x-model="formData.course" class="w-full bg-white/50 border-b-2 border-stone-100 px-2 py-3 outline-none focus:border-stone-400 cursor-pointer">
                            
                            <option value="生活・雑用依頼">生活・雑用依頼 (推奨ランクF~)</option>
                            <option value="採取・収集依頼">採取・収集依頼 (推奨ランクE~)</option>
                            <option value="低級討伐依頼">低級討伐依頼 (推奨ランクD~)</option>
                            <option value="中級討伐依頼">中級討伐依頼 (推奨ランクC~)</option>
                            <option value="護衛依頼">護衛依頼 (推奨ランクB~)</option>
                            <option value="上級討伐依頼">上級討伐依頼 (推奨ランクA~)</option>
                            <option value="特殊依頼">特殊依頼 (推奨ランクS~)</option>
                            <option value="その他">その他ご相談</option>
                            
                            <!--
                            <option value="PC・IT操作サポート">PC・IT操作サポート（設定・トラブル解決）</option>
                            <option value="デザイン・制作相談">デザイン・制作相談（Web・バナー・資料等）</option>
                            <option value="リサーチ・データ収集">リサーチ・データ収集（市場調査・リスト作成）</option>
                            <option value="システム・ツール導入支援">システム・ツール導入支援（SaaS・AI活用）</option>
                            <option value="Webサイト保守・更新">Webサイト保守・更新（修正・管理代行）</option>
                            <option value="その他ご相談">その他ご相談</option>
                            -->
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] font-bold tracking-[0.3em] text-stone-400 flex items-center gap-2"><i data-lucide="message-circle" class="w-3 h-3"></i> 本文 (備考)</label>
                        <textarea x-model="formData.message" rows="4" placeholder="具体的なご要望などをご記入ください..."
                                    class="w-full bg-white/50 border border-stone-100 rounded-xl p-4 outline-none focus:border-rose-200 focus:bg-white/80 resize-none transition-colors"></textarea>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <input type="checkbox" x-model="agreement" required class="w-4 h-4 accent-orange-600 cursor-pointer">
                        <span class="text-xs text-stone-400"><a href="./privacy.html" target="_blank" class="text-rose-400 underline decoration-rose-200">個人情報の取り扱い</a> に同意する</span>
                    </div>
                </div>

                <button type="submit" :disabled="isSubmitting || !formData.time"
                        class="w-full bg-rose-400 hover:bg-rose-500 text-white font-bold py-5 rounded-full shadow-lg shadow-rose-200 transition-all duration-500 hover:scale-[1.01] flex items-center justify-center gap-3 disabled:opacity-50 disabled:hover:scale-100 disabled:cursor-not-allowed">
                    <span x-show="!isSubmitting" class="text-sm tracking-[0.8em] ml-2 flex items-center gap-2">送信する <i data-lucide="send" class="w-4 h-4"></i></span>
                    <span x-show="isSubmitting" class="text-sm tracking-[0.2em] flex items-center gap-2"><div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> 処理中...</span>
                </button>
            </form>
        </div>
    </div>

    <script>
    // 桜アニメーション (変更なし)
    class SakuraAnimation {
        constructor(canvas) {
            this.canvas = canvas; this.ctx = canvas.getContext('2d'); this.petals = [];
            this.resize(); window.addEventListener('resize', () => this.resize());
            this.init(); this.animate();
        }
        resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; }
        init() {
            for (let i = 0; i < 50; i++) {
                this.petals.push({
                    x: Math.random() * this.canvas.width, y: Math.random() * this.canvas.height,
                    size: Math.random() * 8 + 10, speed: Math.random() * 0.7 + 0.3,
                    wind: Math.random() * 0.6 - 0.3, angle: Math.random() * 360,
                    rotateSpeed: Math.random() * 1.2 - 0.6, flip: Math.random() * Math.PI,
                    flipSpeed: Math.random() * 0.04 + 0.01,
                    color: `rgba(255, ${215 + Math.random() * 25}, ${225 + Math.random() * 20}, ${0.5 + Math.random() * 0.4})`
                });
            }
        }
        drawPetal(p) {
            const { ctx } = this; ctx.save();
            ctx.translate(p.x, p.y); ctx.rotate(p.angle * Math.PI / 180); ctx.scale(Math.cos(p.flip), 1);
            ctx.beginPath(); ctx.fillStyle = p.color; const s = p.size;
            ctx.moveTo(0, 0); ctx.bezierCurveTo(-s * 0.4, -s * 0.5, -s * 1.2, -s * 1.1, -s * 0.4, -s * 2.0);
            ctx.lineTo(0, -s * 1.5); ctx.lineTo(s * 0.4, -s * 2.0);
            ctx.bezierCurveTo(s * 1.2, -s * 1.1, s * 0.4, -s * 0.5, 0, 0);
            ctx.fill(); ctx.restore();
        }
        animate() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.petals.forEach(p => {
                p.y += p.speed; p.x += p.wind; p.angle += p.rotateSpeed; p.flip += p.flipSpeed;
                if (p.y > this.canvas.height + 40) { p.y = -40; p.x = Math.random() * this.canvas.width; }
                this.drawPetal(p);
            });
            requestAnimationFrame(() => this.animate());
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new SakuraAnimation(document.querySelector('.animation-canvas'));
        lucide.createIcons();
    });

    function bookingSystem() {
        const GAS_URL = "https://script.google.com/macros/s/AKfycbysl-NeiCjnwAfLAryU4ptHpX-o5eYyQCORCwSo41Deost8YRoQHZ02_-EQBYtH9c9LRw/exec"; 

        return {
            step: 'form',
            isLoadingSlots: false,
            isSubmitting: false,
            minDate: '',
            agreement: false,
            timeSlots: ["10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"],
            bookedSlots: [],
            formData: { date: '', time: '', name: '', tel: '', course: '通常コース', message: '' },
            result: { id: '', date: '', time: '' },

            init() {
                const d = new Date(); d.setDate(d.getDate() + 3);
                this.minDate = d.toISOString().split('T')[0];
            },

            formatDateJP(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[0]}年${Number(parts[1])}月${Number(parts[2])}日`;
                }
                return dateStr;
            },

            async fetchSlots() {
                if (!this.formData.date) return;
                
                // 日付が変わったら一旦リセット
                this.formData.time = '';
                this.bookedSlots = [];
                this.isLoadingSlots = true;
                
                try {
                    const response = await fetch(`${GAS_URL}?action=getSlots&date=${this.formData.date}`);
                    const data = await response.json();
                    
                    if (Array.isArray(data)) {
                        // 文字列として確実に処理
                        this.bookedSlots = data.map(t => String(t));
                    } else {
                        console.error("Invalid data format:", data);
                        this.bookedSlots = [];
                    }
                } catch (e) {
                    console.error("Fetch slots error:", e);
                    alert("予約状況の取得に失敗しました。通信環境を確認してください。");
                } finally {
                    this.isLoadingSlots = false;
                }
            },

            async submitReservation() {
                if (!this.agreement) return alert("個人情報の取扱いに同意してください。");
                if (!this.formData.time) return alert("時間を選択してください。");
                
                this.isSubmitting = true;
                
                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({
                            action: 'addUser',
                            ...this.formData
                        })
                    });
                    const res = await response.json();
                    
                    if (res.success) {
                        this.result = res;
                        this.step = 'success';
                        // 画面トップへスクロール
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        alert(res.msg);
                        // 「埋まってしまいました」系のメッセージなら最新状況を再取得
                        if(res.msg && res.msg.includes("埋まって")) {
                            this.fetchSlots();
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert("通信エラーが発生しました。もう一度お試しください。");
                } finally {
                    this.isSubmitting = false;
                }
            },

            downloadTicket() {
                const target = document.getElementById('ticketArea');
                html2canvas(target).then(canvas => {
                    const a = document.createElement('a');
                    a.href = canvas.toDataURL("image/png");
                    a.download = `予約票_${this.result.id}.png`;
                    a.click();
                });
            }
        }
    }
  </script>
</body>
</html>