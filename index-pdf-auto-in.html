<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é³¥Lab - PDFæºå°ã‚·ã‚¹ãƒ†ãƒ </title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="import.css">
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="html,css,javascript,å°é³¥Lab">
    <link rel="icon" href="./img/å’Œlogo.ico">
    <meta name="description" content="webã‚µã‚¤ãƒˆä½“é¨“ã‚’ã‚‚ã£ã¨æ¥½ã—ãç°¡å˜ã«!!">
    <meta property="og:image" content="./img/å’Œlogo.avif">
    <meta property="og:title" content="å°é³¥Lab">
    <meta property="og:site_name" content="å°é³¥Lab">
    <meta property="og:description" content="webã‚µã‚¤ãƒˆä½“é¨“ã‚’ã‚‚ã£ã¨æ¥½ã—ãç°¡å˜ã«!!">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>

    <style>
        :root {
            --primary-color: #5e81ac;
            --accent-color: #d08770;
            --bg-color: #eceff4;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --text-color: #4c566a;
            --radius: 12px;
        }

        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .fs-h2 { font-size: 1.5rem; font-weight: bold; }
        .fs-b5 { font-weight: 500; }
        .fs-b7 { font-size: 0.9rem; }
        .fs-b10 { font-size: 0.8rem; color: #888; }
        .mt-02 { margin-top: 2rem; }
        .t-cc { text-align: center; }
        .color-b1-20 { color: var(--primary-color); }
        .hidden { display: none !important; }

        .pdf-tool-wrapper {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .section-title {
            display: block;
            font-weight: bold;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 15px;
            width: 100%;
        }

        /* å·¦ã‚«ãƒ©ãƒ : è¨­å®šã‚¨ãƒªã‚¢ */
        .control-panel {
            flex: 1;
            min-width: 320px;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* å³ã‚«ãƒ©ãƒ : ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        .preview-panel {
            flex: 1.5;
            min-width: 320px;
            background: #2e3440; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ */
            padding: 20px;
            border-radius: var(--radius);
            height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone-v2 {
            border: 2px dashed #ccc;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            background: #fafafa;
            transition: 0.3s;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .drop-zone-v2:hover, .drop-zone-v2.dragover {
            border-color: var(--primary-color);
            background: #eef4fc;
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .settings-grid {
            display: grid;
            gap: 15px;
        }
        .setting-item label {
            display: block;
            margin-bottom: 5px;
        }
        .custom-select, .custom-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d8dee9;
            border-radius: 6px;
            box-sizing: border-box;
            background: #fff;
        }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .mode-tabs {
            display: flex;
            background: #e5e9f0;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 15px;
        }
        .mode-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.2s;
            color: #888;
        }
        .mode-tab.active {
            background: #fff;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚»ãƒƒãƒˆ */
        .slider-group {
            background: #f4f6f9;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .slider-row span { width: 20px; font-weight: bold; font-size: 0.8rem; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--primary-color); }
        input[type="number"] { width: 50px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; }

        /* ãƒœã‚¿ãƒ³ */
        .btn-merge {
            background: linear-gradient(135deg, var(--primary-color), #81a1c1);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(94, 129, 172, 0.3);
        }
        .btn-merge:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(94, 129, 172, 0.4); }
        .btn-merge:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼Canvas */
        .preview-scroll {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: #3b4252;
            border-radius: 8px;
            padding: 20px;
        }
        .canvas-container {
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background: white;
            transform-origin: top center;
            transition: transform 0.2s;
        }
        
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #overlay { position: absolute; pointer-events: none; display: none; z-index: 10; box-sizing: border-box; }
        #overlay.mode-fixed { border: 2px dashed #bf616a; background-size: contain; background-repeat: no-repeat; background-position: center; }
        #overlay.mode-search { border: 2px solid rgba(94, 129, 172, 0.8); background-color: rgba(94, 129, 172, 0.2); }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        #progressLog {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #4c566a;
            background: #e5e9f0;
            padding: 10px;
            border-radius: 6px;
            max-height: 100px;
            overflow-y: auto;
            font-family: monospace;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .hero-container2 {
            margin-top: auto;
            text-align: center;
            padding: 20px;
            background: #2e3440;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .glitch { font-size: 1rem; position: relative; display: inline-block; }
    </style>
</head>

<body class="fs-h6 us-n bg-container-img5" oncontextmenu="return false;">
    <div id="stalker"></div>
    <div id="loading"></div>
    <div class="mt-02 color-b1-20 t-cc fs-h2 fs-b5">- ä¾¿åˆ©ãƒ„ãƒ¼ãƒ« PDF æºå°ã‚·ã‚¹ãƒ†ãƒ  -</div>

    <main class="pdf-tool-wrapper">
        
        <div class="control-panel">
            <span class="section-title">1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</span>
            
            <div id="drop-zone-pdf" class="drop-zone-v2" onclick="document.getElementById('pdfInput').click()">
                <p class="fs-h6">ã‚¯ãƒªãƒƒã‚¯ã—ã¦<samp class="color-r1-100">PDF</samp>ã‚’é¸æŠ</p>
                <span class="fs-b7" id="pdf-name">æœªé¸æŠ</span>
                <input type="file" id="pdfInput" accept="application/pdf" hidden onchange="handleFileSelect(this, 'pdf')">
            </div>

            <div id="drop-zone-img" class="drop-zone-v2" onclick="document.getElementById('imgInput').click()">
                <p class="fs-h6">ã‚¯ãƒªãƒƒã‚¯ã—ã¦<samp class="color-r1-100">å°é‘‘ç”»åƒ</samp>ã‚’é¸æŠ</p>
                <span class="fs-b7" id="img-name">æœªé¸æŠ (PNG/JPG)</span>
                <input type="file" id="imgInput" accept="image/png, image/jpeg" hidden onchange="handleFileSelect(this, 'img')">
            </div>

            <span class="section-title">2. æºå°è¨­å®š</span>
            <div class="settings-grid">
                <div class="setting-item">
                    <label class="fs-b7 fs-b10">å°é‘‘ã‚µã‚¤ã‚º (mm)</label>
                    <select id="sealSize" class="custom-select" onchange="updatePreview()">
                        <option value="10">10mm (èªå°)</option>
                        <option value="12">12mm (éŠ€è¡Œå°)</option>
                        <option value="15">15mm (å®Ÿå°)</option>
                        <option value="21" selected>21mm (è§’å°)</option>
                        <option value="24">24mm (è§’å°ãƒ»å¤§)</option>
                        <option value="30">30mm (ç¤¾å°)</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="fs-b7 fs-b10">å‹•ä½œãƒ¢ãƒ¼ãƒ‰</label>
                    <div class="mode-tabs">
                        <div class="mode-tab active" onclick="setMode('fixed')" id="tab-fixed">å›ºå®šä½ç½®</div>
                        <div class="mode-tab" onclick="setMode('search')" id="tab-search">æ–‡å­—æ¤œç´¢</div>
                    </div>
                </div>

                <div id="content-fixed" class="mode-content">
                    <div class="slider-group">
                        <label class="fs-b7">ä½ç½®èª¿æ•´ (X:æ¨ª / Y:ç¸¦)</label>
                        <div class="slider-row">
                            <span>X</span>
                            <input type="range" id="rangeX_fixed" min="0" max="500" value="100" oninput="syncVal('rangeX_fixed', 'numX_fixed')">
                            <input type="number" id="numX_fixed" value="100" oninput="syncVal('numX_fixed', 'rangeX_fixed')">
                        </div>
                        <div class="slider-row">
                            <span>Y</span>
                            <input type="range" id="rangeY_fixed" min="0" max="800" value="100" oninput="syncVal('rangeY_fixed', 'numY_fixed')">
                            <input type="number" id="numY_fixed" value="100" oninput="syncVal('numY_fixed', 'rangeY_fixed')">
                        </div>
                    </div>
                </div>

                <div id="content-search" class="mode-content hidden">
                    <div class="setting-item">
                        <input type="text" id="searchText" class="custom-input" placeholder="æ¤œç´¢ã™ã‚‹æ–‡å­— (ä¾‹: æ‰¿èª)" style="margin-bottom:10px;">
                        
                        <label style="font-size:0.85rem; display:flex; align-items:center; cursor:pointer; color: var(--text-color); font-weight: bold;">
                            <input type="checkbox" id="useOCR" checked style="margin-right:8px; width: auto;"> OCR(ç”»åƒèªè­˜)ã‚’ä½µç”¨ã™ã‚‹
                        </label>
                        
                        <div style="background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; border-left: 4px solid #ffeeba; margin-top: 8px; font-size: 0.75rem; line-height: 1.4;">
                            <span style="font-weight: bold;">ğŸ’¡ ã‚¹ã‚­ãƒ£ãƒ³æ¸ˆã¿PDFã«å¯¾å¿œ:</span><br>
                            ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒãªã„ç”»åƒå½¢å¼ã®PDFã§ã‚‚æ–‡å­—ã‚’æ¤œå‡ºã§ãã¾ã™ã€‚<br>
                            â€»OCRæŠ€è¡“ã®æ€§è³ªä¸Šæ¤œå‡ºç‡ã¯100%ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                            <span style="color: #bc810d;">â€»åˆå›å®Ÿè¡Œæ™‚ã¯è§£æè¾æ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æ•°ç§’ã€œæ•°åç§’ã‹ã‹ã‚Šã¾ã™ã€‚</span>
                        </div>
                    </div>
                    
                    <div class="slider-group" style="margin-top:10px;">
                        <label class="fs-b7">æ¤œç´¢ç¯„å›² (é’æ å†…ã®ã¿)</label>
                        <div class="slider-row"><span>X</span><input type="range" id="rangeX_search" value="0" oninput="syncVal('rangeX_search', 'numX_search')"><input type="number" id="numX_search" value="0"></div>
                        <div class="slider-row"><span>Y</span><input type="range" id="rangeY_search" value="0" oninput="syncVal('rangeY_search', 'numY_search')"><input type="number" id="numY_search" value="0"></div>
                        <div class="slider-row"><span>W</span><input type="range" id="rangeW_search" value="200" oninput="syncVal('rangeW_search', 'numW_search')"><input type="number" id="numW_search" value="200"></div>
                        <div class="slider-row"><span>H</span><input type="range" id="rangeH_search" value="200" oninput="syncVal('rangeH_search', 'numH_search')"><input type="number" id="numH_search" value="200"></div>
                    </div>
                </div>
            </div>

            <button id="runBtn" class="btn-merge" onclick="runProcess()">å‡¦ç†å®Ÿè¡Œ & ä¿å­˜</button>
            <div id="progressLog">æº–å‚™å®Œäº†</div>
        </div>

        <div class="preview-panel">
            <div style="display:flex; justify-content:space-between; color:#fff; margin-bottom:10px; align-items:center;">
                <span class="fs-b7">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (Page 1)</span>
                <select id="zoomLevel" class="custom-select" style="width:auto; padding:4px 8px; height:auto;" onchange="updateZoom()">
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1.0" selected>100%</option>
                    <option value="1.5">150%</option>
                    <option value="2.0">200%</option>
                </select>
            </div>
            
            <div class="preview-scroll">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                    <div id="overlay"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="hero-container2">
        <div class="environment"></div>
        <div class="hero glitch layers fs-b5 fs-h8 text-shadow-2b" data-text="Â© å°é³¥Labç ”ç©¶æ‰€">
            <span class="color-000">Â© å°é³¥Labç ”ç©¶æ‰€</span>
        </div>
    </div>

    <script>
        // --- Logic Core ---
        let previewPdfDoc = null; 
        let imgDataUrl = null;
        let pageInfo = { w: 0, h: 0 };
        let currentMode = 'fixed';
        const mmToPt = (mm) => mm * 2.8346;
        
        const logger = {
            el: document.getElementById('progressLog'),
            log: function(msg) {
                console.log(msg);
                this.el.innerText = msg;
            },
            append: function(msg) {
                this.el.innerText += "\n" + msg;
                this.el.scrollTop = this.el.scrollHeight;
            }
        };

        // UI Helpers
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            document.getElementById('content-fixed').classList.add('hidden');
            document.getElementById('content-search').classList.add('hidden');
            document.getElementById(`content-${mode}`).classList.remove('hidden');
            
            updatePreview();
        }

        function syncVal(src, tgt) {
            document.getElementById(tgt).value = document.getElementById(src).value;
            updatePreview();
        }

        function updateZoom() {
            const zoom = document.getElementById('zoomLevel').value;
            document.getElementById('canvasContainer').style.transform = `scale(${zoom})`;
        }

        function updateSliderMax(id, max) {
            const el = document.getElementById(id);
            if(el) el.max = Math.floor(max);
        }

        // File Handling
        function handleFileSelect(input, type) {
            const file = input.files[0];
            if(!file) return;
            
            if(type === 'pdf') {
                document.getElementById('pdf-name').innerText = file.name;
                document.getElementById('drop-zone-pdf').style.borderColor = 'var(--primary-color)';
                loadPDF(file);
            } else {
                document.getElementById('img-name').innerText = file.name;
                document.getElementById('drop-zone-img').style.borderColor = 'var(--primary-color)';
                loadImage(file);
            }
        }

        async function loadPDF(file) {
            try {
                const buffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: buffer });
                previewPdfDoc = await loadingTask.promise;
                
                const page = await previewPdfDoc.getPage(1);
                const viewport = page.getViewport({ scale: 1.0 });
                pageInfo.w = viewport.width;
                pageInfo.h = viewport.height;

                const canvas = document.getElementById('pdfCanvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ€å¤§å€¤è¨­å®š
                ['rangeX_fixed','rangeY_fixed','rangeX_search','rangeY_search','rangeW_search','rangeH_search'].forEach(id => {
                    updateSliderMax(id, (id.includes('Y') || id.includes('H')) ? pageInfo.h : pageInfo.w);
                });
                
                // åˆæœŸå€¤ã‚»ãƒƒãƒˆ(ä¸­å¤®)
                const cx = Math.floor(pageInfo.w / 2);
                const cy = Math.floor(pageInfo.h / 2);
                if(document.getElementById('numX_fixed').value == 100) {
                    document.getElementById('rangeX_fixed').value = cx; document.getElementById('numX_fixed').value = cx;
                    document.getElementById('rangeY_fixed').value = cy; document.getElementById('numY_fixed').value = cy;
                    document.getElementById('rangeW_search').value = Math.floor(pageInfo.w);
                    document.getElementById('rangeH_search').value = Math.floor(pageInfo.h);
                    syncVal('rangeW_search','numW_search'); syncVal('rangeH_search','numH_search');
                }
                updatePreview();
            } catch(e) {
                alert("PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imgDataUrl = e.target.result;
                updatePreview();
            };
            reader.readAsDataURL(file);
        }

        // Preview Logic
        function updatePreview() {
            if (pageInfo.h === 0) return;
            const overlay = document.getElementById('overlay');
            const sizePt = mmToPt(parseFloat(document.getElementById('sealSize').value));

            overlay.className = '';
            overlay.classList.add(currentMode === 'fixed' ? 'mode-fixed' : 'mode-search');
            overlay.style.display = 'block';

            if (currentMode === 'fixed') {
                if (imgDataUrl) overlay.style.backgroundImage = `url(${imgDataUrl})`;
                const x = parseFloat(document.getElementById('numX_fixed').value) || 0;
                const y = parseFloat(document.getElementById('numY_fixed').value) || 0;
                
                overlay.style.width = `${sizePt}px`;
                overlay.style.height = `${sizePt}px`;
                overlay.style.left = `${x - (sizePt/2)}px`;
                overlay.style.top = `${pageInfo.h - y - (sizePt/2)}px`;
            } else {
                overlay.style.backgroundImage = 'none';
                const x = parseFloat(document.getElementById('numX_search').value) || 0;
                const y = parseFloat(document.getElementById('numY_search').value) || 0;
                const w = parseFloat(document.getElementById('numW_search').value) || 0;
                const h = parseFloat(document.getElementById('numH_search').value) || 0;

                overlay.style.width = `${w}px`;
                overlay.style.height = `${h}px`;
                overlay.style.left = `${x}px`;
                overlay.style.top = `${pageInfo.h - y - h}px`;
            }
        }

        // Main Execution
        async function runProcess() {
            const pdfFile = document.getElementById('pdfInput').files[0];
            const imgFile = document.getElementById('imgInput').files[0];
            if (!pdfFile || !imgFile) return alert("PDFã¨å°é‘‘ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            logger.log("å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...");

            try {
                // PDF-LIB & Buffer Load
                const pdfBuffer = await pdfFile.arrayBuffer();
                const imgBuffer = await imgFile.arrayBuffer();
                const pdfDocLib = await PDFLib.PDFDocument.load(pdfBuffer);
                
                // PDF.JS for Analysis
                const loadingTask = pdfjsLib.getDocument({ data: pdfBuffer.slice(0) });
                const processingPdfDoc = await loadingTask.promise;

                // Embed Image
                let embedImg;
                if (imgFile.type === 'image/jpeg') embedImg = await pdfDocLib.embedJpg(imgBuffer);
                else embedImg = await pdfDocLib.embedPng(imgBuffer);
                
                const sizePt = mmToPt(parseFloat(document.getElementById('sealSize').value));
                const imgDims = embedImg.scaleToFit(sizePt, sizePt);
                const totalPages = pdfDocLib.getPageCount();
                let count = 0;

                if (currentMode === 'fixed') {
                    const x = parseFloat(document.getElementById('numX_fixed').value);
                    const y = parseFloat(document.getElementById('numY_fixed').value);
                    logger.log("å…¨ãƒšãƒ¼ã‚¸ã«æºå°ä¸­...");
                    for (let i = 0; i < totalPages; i++) {
                        const page = pdfDocLib.getPage(i);
                        page.drawImage(embedImg, {
                            x: x - imgDims.width/2,
                            y: y - imgDims.height/2,
                            width: imgDims.width, height: imgDims.height
                        });
                        count++;
                    }
                } else {
                    const searchStr = document.getElementById('searchText').value;
                    const useOCR = document.getElementById('useOCR').checked;
                    const areaX = parseFloat(document.getElementById('numX_search').value);
                    const areaY = parseFloat(document.getElementById('numY_search').value);
                    const areaW = parseFloat(document.getElementById('numW_search').value);
                    const areaH = parseFloat(document.getElementById('numH_search').value);

                    if(!searchStr) throw new Error("æ¤œç´¢æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    
                    let worker = null;
                    if (useOCR) {
                        logger.log("OCRã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...");
                        worker = await Tesseract.createWorker('jpn');
                    }

                    for (let i = 1; i <= totalPages; i++) {
                        logger.log(`Page ${i}/${totalPages} ã‚’è§£æä¸­...`);
                        let foundOnPage = false;

                        // 1. Text Layer
                        const page = await processingPdfDoc.getPage(i);
                        const textContent = await page.getTextContent();
                        const libPage = pdfDocLib.getPages()[i - 1];

                        for (const item of textContent.items) {
                            if (!item.str || !item.transform) continue;
                            if (item.str.includes(searchStr)) {
                                const tx = item.transform[4];
                                const ty = item.transform[5];
                                if (tx >= areaX && tx <= (areaX + areaW) && ty >= areaY && ty <= (areaY + areaH)) {
                                    libPage.drawImage(embedImg, {
                                        x: tx + (item.width/2) - (imgDims.width/2),
                                        y: ty + (item.height/2) - (imgDims.height/2),
                                        width: imgDims.width, height: imgDims.height
                                    });
                                    foundOnPage = true; count++;
                                }
                            }
                        }

                        // 2. OCR
                        if (!foundOnPage && useOCR && worker) {
                            logger.log(`Page ${i}: OCRè§£æå®Ÿè¡Œä¸­...`);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                            const { data: { words } } = await worker.recognize(canvas);
                            const pdfW = libPage.getWidth();
                            const pdfH = libPage.getHeight();
                            const ratioX = pdfW / canvas.width;
                            const ratioY = pdfH / canvas.height;

                            for (const word of words) {
                                if (word.text.replace(/\s/g, '').includes(searchStr)) {
                                    const cx_px = (word.bbox.x0 + word.bbox.x1) / 2;
                                    const cy_px = (word.bbox.y0 + word.bbox.y1) / 2;
                                    const pdfX = cx_px * ratioX;
                                    const pdfY = pdfH - (cy_px * ratioY);

                                    if (pdfX >= areaX && pdfX <= (areaX + areaW) && pdfY >= areaY && pdfY <= (areaY + areaH)) {
                                        libPage.drawImage(embedImg, {
                                            x: pdfX - (imgDims.width/2),
                                            y: pdfY - (imgDims.height/2),
                                            width: imgDims.width, height: imgDims.height
                                        });
                                        count++;
                                    }
                                }
                            }
                        }
                    }
                    if (worker) await worker.terminate();
                }

                const pdfBytes = await pdfDocLib.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'stamped_result.pdf';
                link.click();
                
                logger.log(`å®Œäº†! ${count}ç®‡æ‰€ã«æºå°ã—ã¾ã—ãŸã€‚`);
                alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚\nè¨ˆ ${count} ç®‡æ‰€ã«æºå°ã—ã¾ã—ãŸã€‚`);

            } catch (e) {
                console.error(e);
                logger.log("ã‚¨ãƒ©ãƒ¼: " + e.message);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            } finally {
                btn.disabled = false;
            }
        }
        
        // Init Drag & Drop
        ['drop-zone-pdf', 'drop-zone-img'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('dragover'); });
            el.addEventListener('dragleave', (e) => { e.preventDefault(); el.classList.remove('dragover'); });
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                el.classList.remove('dragover');
                const type = id.includes('pdf') ? 'pdf' : 'img';
                const inputId = id.includes('pdf') ? 'pdfInput' : 'imgInput';
                document.getElementById(inputId).files = e.dataTransfer.files;
                handleFileSelect(document.getElementById(inputId), type);
            });
        });
    </script>
    <script src="./script/click.js"></script>
    <script src="./script/stalker.js"></script>
    <script src="./script/slideshow.js"></script>
    <script src="./script/CanvasAnimation.js"></script>
    <script src="./script/import.js"></script>
    <!--<script src="./script/first.js" defer></script>-->
    <script src="./script/clipboad.js"></script>
    <script src="./script/load.js"></script>
    <script src="./script/sidebar.js"></script>
    <script src="./script/pdfto.js"></script>
</body>
</html>