<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°é³¥Lab</title>
    <link rel="stylesheet" href="import.css">
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="html,css,javascript,å°é³¥Lab">
    <link rel="icon" href="./img/å’Œlogo.ico">
    <meta name="description" content="webã‚µã‚¤ãƒˆä½“é¨“ã‚’ã‚‚ã£ã¨æ¥½ã—ãç°¡å˜ã«!!">
    <meta property="og:image" content="./img/å’Œlogo.avif">
    <meta property="og:title" content="å°é³¥Lab">
    <meta property="og:site_name" content="å°é³¥Lab">
    <meta property="og:description" content="webã‚µã‚¤ãƒˆä½“é¨“ã‚’ã‚‚ã£ã¨æ¥½ã—ãç°¡å˜ã«!!">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body class="fs-h6 us-n bg-container-img5" oncontextmenu="return false;">
    <div id="stalker"></div>
    <div id="loading"></div>

<!--/////-->
<style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
        margin: 0;
        padding: 0;
        background: #f0f2f5;
        font-family: sans-serif;
    }

    .pdf-tool-wrapper {
        max-width: 850px;
        margin: 40px auto;
        padding: 30px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 24px;
        color: #1a1a1a;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 12px;
        display: block;
        border-left: 4px solid #000;
        padding-left: 10px;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
        background: rgba(255, 255, 255, 0.6);
        padding: 20px;
        border-radius: 16px;
        align-items: start;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 85px;
    }

    .custom-input, .custom-select {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: #fff;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .checkbox_icon {
        position: relative;
        width: 22px;
        height: 22px;
        appearance: none;
        -webkit-appearance: none;
        background: #FFFFFF;
        border: solid 2px #808080;
        border-radius: 4px;
        cursor: pointer;
        flex-shrink: 0;
        transition: 0.2s;
    }
    .checkbox_icon:checked { background-color: #000; border-color: #000; }
    .checkbox_icon:checked::after {
        content: ''; position: absolute; left: 6px; top: 2px;
        width: 5px; height: 10px; border: solid #FFF;
        border-width: 0 2px 2px 0; transform: rotate(45deg);
    }

    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }

    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
    .drop-zone-v2 {
        border: 2px dashed rgba(0, 0, 0, 0.2);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        background: rgba(255, 255, 255, 0.3);
        cursor: pointer;
        margin: 5px 0 20px 0;
        transition: 0.3s;
    }
    .drop-zone-v2:hover { background: rgba(255, 255, 255, 0.6); border-color: #000; }

    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 10px;
        max-height: 250px;
        overflow-y: auto;
        margin: 20px 0;
        padding: 4px;
    }

    .file-item {
        position: relative; font-size: 10px; background: #fff;
        padding: 10px 5px; border-radius: 6px; text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        word-break: break-all;
    }

    .btn-remove {
        position: absolute; top: -5px; right: -5px;
        width: 18px; height: 18px; background: #000; color: #fff;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 2;
    }

    .btn-merge {
        width: 100%; padding: 20px; background: #000; color: #fff;
        border: none; border-radius: 50px; font-weight: bold;
        cursor: pointer; font-size: 1.1rem;
        transition: opacity 0.3s;
    }
    .btn-merge:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-clear-all {
        border: none; background: none; text-decoration: underline; 
        cursor: pointer; font-size: 0.8rem; color: #666;
    }

    .fs-b7 { font-size: 0.8rem; }
    .fs-b10 { font-weight: bold; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<main class="pdf-tool-wrapper">
    <span class="section-title">1. ç”»åƒã®èª­ã¿è¾¼ã¿</span>
    <div id="drop-zone" class="drop-zone-v2">
        <p class="fs-h6">ã‚¯ãƒªãƒƒã‚¯ã—ã¦<samp class="fs-b10">ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨</samp>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
        <span class="fs-b7">JPG, PNG, WebP, AVIF å¯¾å¿œ</span>
        <input type="file" id="file-input" webkitdirectory directory multiple hidden>
    </div>

    <span class="section-title">2. PDFå‡ºåŠ›è¨­å®š</span>
    <div class="settings-grid">
        <div class="setting-item">
            <label class="checkbox-label">
                <input class="checkbox_icon" type="checkbox" id="rename-check"> åå‰ã‚’æŒ‡å®š
            </label>
            <input type="text" id="custom-filename-input" class="custom-input hidden" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›" autocomplete="off">
        </div>

        <div class="setting-item">
            <label class="fs-b7" style="font-weight:bold;">ç”»è³ªï¼ˆåœ§ç¸®ç‡ï¼‰</label>
            <select id="compression-level" class="custom-select">
                <option value="1.0">ã‚ªãƒªã‚¸ãƒŠãƒ« (åœ§ç¸®ãªã—)</option>
                <option value="0.8" selected>é«˜ç”»è³ª (80%)</option>
                <option value="0.5">ä¸­ç”»è³ª (50%)</option>
                <option value="0.3">ä½ç”»è³ª (30% - è»½é‡)</option>
            </select>
        </div>

        <div class="setting-item">
            <label class="fs-b7" style="font-weight:bold;">ä½™ç™½ï¼ˆãƒãƒ¼ã‚¸ãƒ³ï¼‰</label>
            <select id="margin-size" class="custom-select">
                <option value="0">ä½™ç™½ãªã— (ãƒ•ãƒ«ã‚µã‚¤ã‚º)</option>
                <option value="20">å°‘ã—ã‚ã‘ã‚‹ (æ¨™æº–)</option>
                <option value="50">ãŸã£ã·ã‚Šã‚ã‘ã‚‹</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label class="fs-b7" style="font-weight:bold;">ä¸¦ã³æ›¿ãˆ</label>
            <select id="sort-order" class="custom-select">
                <option value="name-asc">åå‰é † (æ˜‡é †)</option>
                <option value="name-desc">åå‰é † (é™é †)</option>
                <option value="date-new">æ–°ã—ã„é †</option>
            </select>
        </div>

        <div class="setting-item">
            <label class="checkbox-label">
                <input class="checkbox_icon" type="checkbox" id="password-check"> ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·
            </label>
            <input type="password" id="pdf-password-input" class="custom-input hidden" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="new-password">
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="file-count" class="fs-b7">ç”»åƒæœªé¸æŠ</span>
        <button id="clear-all-btn" class="btn-clear-all hidden">ã™ã¹ã¦å‰Šé™¤</button>
    </div>
    
    <div id="file-list" class="file-grid"></div>
    
    <button id="merge-btn" class="btn-merge hidden">PDFã‚’ä½œæˆã—ã¦ä¿å­˜</button>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<script>
    const { jsPDF } = window.jspdf;
    const { PDFDocument } = PDFLib;
    
    // DOMè¦ç´ ã®å–å¾—
    const dom = {
        dropZone: document.getElementById('drop-zone'),
        fileInput: document.getElementById('file-input'),
        mergeBtn: document.getElementById('merge-btn'),
        clearBtn: document.getElementById('clear-all-btn'),
        fileList: document.getElementById('file-list'),
        sortOrder: document.getElementById('sort-order'),
        fileCount: document.getElementById('file-count'),
        
        renameCheck: document.getElementById('rename-check'),
        nameInput: document.getElementById('custom-filename-input'),
        
        passwordCheck: document.getElementById('password-check'),
        passwordInput: document.getElementById('pdf-password-input'),
        
        margin: document.getElementById('margin-size'),
        compression: document.getElementById('compression-level')
    };

    let selectedFiles = [];

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    dom.dropZone.onclick = () => dom.fileInput.click();
    dom.fileInput.onchange = (e) => handleFiles(e.target.files);
    
    // UIåˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    dom.sortOrder.onchange = () => sortAndDisplay();
    
    dom.renameCheck.onchange = e => {
        dom.nameInput.classList.toggle('hidden', !e.target.checked);
        if(e.target.checked) dom.nameInput.focus();
    };
    
    dom.passwordCheck.onchange = e => {
        dom.passwordInput.classList.toggle('hidden', !e.target.checked);
        if(e.target.checked) dom.passwordInput.focus();
    };

    dom.clearBtn.onclick = () => { 
        if(confirm("ãƒªã‚¹ãƒˆã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")) { 
            selectedFiles = []; 
            // fileInputã‚’ãƒªã‚»ãƒƒãƒˆã—ãªã„ã¨åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ããªã„ãŸã‚
            dom.fileInput.value = '';
            updateUI(); 
        } 
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    function handleFiles(files) {
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        if (newFiles.length === 0) return;
        
        selectedFiles = [...selectedFiles, ...newFiles];
        sortAndDisplay();
    }

    function sortAndDisplay() {
        const val = dom.sortOrder.value;
        selectedFiles.sort((a, b) => {
            if (val === 'name-asc') return a.name.localeCompare(b.name, undefined, {numeric: true});
            if (val === 'name-desc') return b.name.localeCompare(a.name, undefined, {numeric: true});
            return b.lastModified - a.lastModified;
        });
        updateUI();
    }

    function updateUI() {
        if (selectedFiles.length === 0) {
            dom.fileList.innerHTML = '';
            dom.fileCount.innerText = 'ç”»åƒæœªé¸æŠ';
            dom.mergeBtn.classList.add('hidden');
            dom.clearBtn.classList.add('hidden');
            return;
        }

        dom.fileList.innerHTML = selectedFiles.map((f, i) => `
            <div class="file-item">
                <div class="btn-remove" onclick="removeFile(${i})">Ã—</div>
                <div style="margin-bottom:4px;">ğŸ–¼</div>
                ${f.name.length > 15 ? f.name.slice(0,12)+'...' : f.name}
            </div>
        `).join('');
        
        dom.fileCount.innerText = `${selectedFiles.length} æšé¸æŠä¸­`;
        dom.mergeBtn.classList.remove('hidden');
        dom.clearBtn.classList.remove('hidden');
    }

    window.removeFile = (i) => { 
        selectedFiles.splice(i, 1); 
        updateUI(); 
    };

    // ç”»åƒèª­ã¿è¾¼ã¿ã¨Canvasã«ã‚ˆã‚‹åœ§ç¸®å‡¦ç†
    const processImage = (file, quality) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    
                    const finalFormat = (quality < 1.0) ? 'image/jpeg' : file.type;
                    const compressedData = canvas.toDataURL(finalFormat, quality);
                    
                    resolve({
                        data: compressedData,
                        width: img.width,
                        height: img.height,
                        format: finalFormat === 'image/jpeg' ? 'JPEG' : 'PNG'
                    });
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    };

    // PDFç”Ÿæˆå‡¦ç†
    dom.mergeBtn.onclick = async () => {
        if (selectedFiles.length === 0) return;

        const originalText = dom.mergeBtn.innerText;
        dom.mergeBtn.disabled = true;
        dom.mergeBtn.innerText = "å‡¦ç†ä¸­ (0/" + selectedFiles.length + ")...";

        try {
            const quality = parseFloat(dom.compression.value);
            const margin = parseInt(dom.margin.value);
            const usePassword = dom.passwordCheck.checked;
            const password = dom.passwordInput.value;

            let doc = null;

            for (let i = 0; i < selectedFiles.length; i++) {
                dom.mergeBtn.innerText = `å‡¦ç†ä¸­ (${i + 1}/${selectedFiles.length})...`;
                
                // ç”»åƒå‡¦ç†
                const imgData = await processImage(selectedFiles[i], quality);
                
                // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºè¨ˆç®—
                const pageWidth = imgData.width + (margin * 2);
                const pageHeight = imgData.height + (margin * 2);
                const orient = pageWidth > pageHeight ? 'l' : 'p';

                if (i === 0) {
                    // 1æšç›®ï¼šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
                    doc = new jsPDF({ 
                        orientation: orient, 
                        unit: 'px', 
                        format: [pageWidth, pageHeight],
                        compress: true 
                    });
                    
                    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆæ©Ÿèƒ½ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                    if (usePassword && password) {
                        if (typeof doc.setEncryption === 'function') {
                            doc.setEncryption(
                                password, password, 
                                ["print", "copy", "modify", "annot-forms"], 
                                "AES_128"
                            );
                        } else {
                            console.warn("æš—å·åŒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                            alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ©Ÿèƒ½ã¯ç¾åœ¨ã®ç’°å¢ƒã§åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚é€šå¸¸ä¿å­˜ã—ã¾ã™ã€‚");
                        }
                    }
                } else {
                    // 2æšç›®ä»¥é™ï¼šæ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ  (ã“ã“ãŒé‡è¦ï¼)
                    doc.addPage([pageWidth, pageHeight], orient);
                }
                
                // ç”»åƒè¿½åŠ 
                doc.addImage(
                    imgData.data, 
                    imgData.format, 
                    margin, 
                    margin, 
                    imgData.width, 
                    imgData.height
                );
                
                await new Promise(r => setTimeout(r, 10));
            }

            const baseName = (dom.renameCheck.checked && dom.nameInput.value) ? dom.nameInput.value : "kotori_collection";
            const fileName = baseName.endsWith('.pdf') ? baseName : baseName + ".pdf";
            
            doc.save(fileName);
            alert("å®Œäº†ã—ã¾ã—ãŸï¼");

        } catch (err) {
            console.error(err);
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
        } finally {
            dom.mergeBtn.disabled = false;
            dom.mergeBtn.innerText = originalText;
        }
    };
</script>

<!--/////-->

    <script src="./script/click.js"></script>
    <script src="./script/stalker.js"></script>
    <script src="./script/slideshow.js"></script>
    <script src="./script/CanvasAnimation.js"></script>
    <script src="./script/import.js"></script>
    <!--<script src="./script/first.js" defer></script>-->
    <script src="./script/clipboad.js"></script>
    <script src="./script/load.js"></script>
    <script src="./script/sidebar.js"></script>
</div>

    <div class="hero-container2">
        <div class="environment"></div>
        <div class="hero glitch layers fs-b5 fs-h8 text-shadow-2b" data-text="Â© å°é³¥Labç ”ç©¶æ‰€"><span class="color-000">Â© å°é³¥Labç ”ç©¶æ‰€</span></div>
    </div>
</body>

</html>