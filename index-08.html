<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小鳥Lab</title>
    <link rel="stylesheet" href="import.css">
    <meta name="robots" content="index, follow">
    <meta name="keywords" content="html,css,javascript,小鳥Lab">
    <link rel="icon" href="./img/和logo.ico">
    <meta name="description" content="webサイト体験をもっと楽しく簡単に!!">
    <meta property="og:image" content="./img/和logo.avif">
    <meta property="og:title" content="小鳥Lab">
    <meta property="og:site_name" content="小鳥Lab">
    <meta property="og:description" content="webサイト体験をもっと楽しく簡単に!!">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body class="fs-h6 us-n bg-container-img5" oncontextmenu="return false;">
    <div id="stalker"></div>
    <div id="loading"></div>

<!--/////-->

    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background: #f0f0f0; -webkit-text-size-adjust: 100%;}
        
        /* プレビューエリア */
        #canvas-container {
            position: relative;
            width: 800px;
            height: 500px; /* 背景画像のサイズに合わせて調整してください */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            background: #ccc;
            overflow: hidden;
        }
        #bg-image { width: 100%; height: 100%; object-fit: cover; }

        /* テキストの配置 */
        .overlay {
            position: absolute;
            color: rgb(0, 0, 0);
            z-index: 10;
            pointer-events: none; /* 操作の邪魔にならないように */
        }
        #text-out-1 { top: 27px; left: 110px; font-size: 24px; }
        #text-out-2 { 
            top: 27px; 
            left: 66.7%; 
            font-size: 26px; 
            letter-spacing: 0.12rem; 
            display: flex;
            align-items: baseline;
        }
        #text-out-3 { 
            top: 43%; 
            left: 100px; 
            font-size: 24px; 
            transform: scale(0.7, 1); /* 横を0.7倍に凝縮 */
            transform-origin: left center; /* 左端を起点に変形させることでズレを解消 */
            display: inline-block; /* scaleを正しく適用するために必要 */
            white-space: nowrap;
            line-height: 25px;
        }
        #text-out-4 { 
            top: 98px; 
            left: 110px; 
            font-size: 24px; 
            transform: scale(0.7, 1); /* 横を0.7倍に凝縮 */
            transform-origin: left center; /* 左端を起点に変形させることでズレを解消 */
            display: inline-block; /* scaleを正しく適用するために必要 */
            white-space: nowrap;
        }

        .date-num {
            font-size: 0.8em;      /* 0.8倍に縮小 */
            font-weight: 400;      /* 極太に */
            font-family: sans-serif; /* 数字を見やすくするためにゴシック系を指定 */
            margin: 0 2px;         /* 数字の左右の微調整 */
        }

        /* 漢字部分（年・月・日）の微調整 */
        .unit {
            font-size: 0.7em;
            font-weight: 400;
            margin-left: 2px;
            margin-right: 4.5px;
        }

        /* 写真枠の設定 */
        #photo-frame {
            position: absolute;
            right: 35px;
            top: 49.5%;
            transform: translateY(-50%);
            width: 210px;
            height: 283px;
            overflow: hidden;
            background: rgba(255,255,255,0.3);
            border: 1px dashed rgba(0,0,0,0.2);
            z-index: 5;
        }

        /* アップロード画像のスタイル（JSで制御） */
        #uploaded-image {
            position: absolute;
            display: none;
            max-width: none; /* 100%制限を外す */
            max-height: none; /* 100%制限を外す */
            object-fit: contain;
        }

        /* 入力フォーム */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 460px;
        }
        input[type="text"] { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
        .slider-group { display: flex; flex-direction: column; margin-top: 5px; }
        .slider-group label { font-size: 12px; color: #666; }
        button {
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            -webkit-appearance: none;
        }
        button:hover { background: #218838; }
    </style>
</head>

<body>

    <div id="canvas-container">
        <img id="bg-image" src="img/免許-resize.avif" crossorigin="anonymous">
        
        <div id="text-out-1" class="overlay">山田　太郎</div>
        <div id="text-out-2" class="overlay">0000<span class="unit">年</span>00<span class="unit">月</span>00<span class="unit">日生</span></div>
        <div id="text-out-3" class="overlay" style="margin-top: 12px;">サブ情報</div>
        <div id="text-out-4" class="overlay">ピポパークカインズ前橋みなみモール店</div>
        
        <div id="photo-frame">
            <img id="uploaded-image" src="" alt="自由画像">
        </div>

        <div id="text-expire" class="overlay" style="top: 155px; left: 45px; color: rgb(0, 0, 0); font-size: 44px; letter-spacing: 0.12rem; "></div>
        <div id="text-kofu" class="overlay" style="top: 127px; left: 138px; font-size: 30px; letter-spacing: 0.12rem;"></div>
        <div id="text-walk" class="overlay" style="top: 376px; left: 84px; font-size: 27px; letter-spacing: 0.03rem;"></div>
        <div id="text-other" class="overlay" style="top: 408px; left: 84px; font-size: 27px; letter-spacing: 0.03rem;"></div>
    </div>

    <div class="controls">
        <label>名前:</label>
        <input type="text" id="input-1" placeholder="名前を入力">
        
        <label>生年月日 (8桁):</label>
        <input type="text" id="input-2" maxlength="8" placeholder="例: 20000101">
        
        <div class="input-item">
            <label>お約束（最大4項目まで）</label>
            
            <div id="checkbox-area" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <label><input type="checkbox" class="preset-check" value="まいにち ハミガキを する。"> ハミガキ</label>
                <label><input type="checkbox" class="preset-check" value="ごはんを のこさず たべる。"> ごはん</label>
                <label><input type="checkbox" class="preset-check" value="お外から帰ったら 手を洗う。"> 手洗い</label>
                <label><input type="checkbox" class="preset-check" value="しゅくだいを すぐにやる。"> しゅくだい</label>
                <label><input type="checkbox" class="preset-check" value="あしたの じゅんびを する。"> じゅんび</label>
                <label><input type="checkbox" class="preset-check" value="お友だちに やさしくする。"> やさしく</label>
                <label><input type="checkbox" class="preset-check" value="お父さんお母さんの言うことを聞くこと"> 01.お父さん</label>
                <label><input type="checkbox" class="preset-check" value="おとうさんおかあさんのいうことをきくこと"> 02.おとうさ</label>
                <label><input type="checkbox" class="preset-check" value="好き嫌いなく何でも食べること"> 03.好き嫌い</label>
                <label><input type="checkbox" class="preset-check" value="すききらいなくなんでもたべること"> 04.すききら</label>
                <label><input type="checkbox" class="preset-check" value="お手伝いをすること"> 05.お手伝い</label>
                <label><input type="checkbox" class="preset-check" value="おてつだいをすること"> 06.おてつだ</label>
                <label><input type="checkbox" class="preset-check" value="いつも笑顔であいさつすること"> 07.いつも笑</label>
                <label><input type="checkbox" class="preset-check" value="いつもえがおであいさつすること"> 08.いつもえ</label>
                <label><input type="checkbox" class="preset-check" value="お勉強を頑張ること"> 09.お勉強を</label>
                <label><input type="checkbox" class="preset-check" value="おべんきょうをがんばること"> 10.おべんき</label>
                <label><input type="checkbox" class="preset-check" value="ゲームをやりすぎないこと"> 11.ゲームを</label>
                <label><input type="checkbox" class="preset-check" value="交通ルールを守ること"> 12.交通ルー</label>
                <label><input type="checkbox" class="preset-check" value="こうつうルールをまもること"> 13.こうつう</label>
                <label><input type="checkbox" class="preset-check" value="お友達と仲良くすること"> 14.お友達と</label>
                <label><input type="checkbox" class="preset-check" value="おともだちとなかよくすること"> 15.おともだ</label>
                <label><input type="checkbox" class="preset-check" value="約束を守ること"> 16.約束を守</label>
                <label><input type="checkbox" class="preset-check" value="やくそくをまもること"> 17.やくそく</label>
                <label><input type="checkbox" class="preset-check" value="ウソをつかないこと"> 18.ウソをつ</label>
            </div>

            <div id="free-input-area" style="display: flex; flex-direction: column; gap: 5px;">
                <input type="text" class="line-input" maxlength="24" placeholder="自由入力 1行目">
                <input type="text" class="line-input" maxlength="24" placeholder="自由入力 2行目">
                <input type="text" class="line-input" maxlength="24" placeholder="自由入力 3行目">
                <input type="text" class="line-input" maxlength="24" placeholder="自由入力 4行目">
            </div>
        </div>
        
        <label>追加画像:</label>
        <input type="file" id="image-upload" accept="image/*">

        <div class="slider-group">
            <label>左右の位置</label>
            <input type="range" id="h-slider" min="-100" max="100" value="0">
        </div>

        <div class="slider-group">
            <label>上下の位置</label>
            <input type="range" id="v-slider" min="-100" max="100" value="0">
        </div>

        <div class="slider-group">
            <label>大きさ（％）</label>
            <input type="range" id="size-slider" min="10" max="200" value="100">
        </div>
        
        <button id="download-btn">画像を書き出す</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script>
        // ページ読み込み時に日付を自動設定
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            
            // 数字を装飾付きで返す関数
            const formatWithSpan = (date) => {
                const y = `<span class="date-num">${date.getFullYear()}</span>`;
                const m = `<span class="date-num">${String(date.getMonth() + 1).padStart(2, '0')}</span>`;
                const d = `<span class="date-num">${String(date.getDate()).padStart(2, '0')}</span>`;
                return { y, m, d };
            };

            const today = formatWithSpan(now);
            
            // 1年後の計算
            const nextYearDate = new Date();
            nextYearDate.setFullYear(now.getFullYear() + 1);
            const nextYear = formatWithSpan(nextYearDate);

            // 有効期限の反映
            const expireEl = document.getElementById('text-expire');
            if (expireEl) {
                expireEl.innerHTML = `${nextYear.y}<span class="unit">年</span>${nextYear.m}<span class="unit">月</span>${nextYear.d}<span class="unit">日まで有効</span>`;
            }

            // 交付日などの反映
            const kofuEl = document.getElementById('text-kofu');
            if (kofuEl) {
                kofuEl.innerHTML = `${today.y}<span class="unit">年</span>${today.m}<span class="unit">月</span>${today.d}<span class="unit">日</span>`;
            }
            
            // 徒歩・他などの項目（必要であれば同様に反映）
            const walkEl = document.getElementById('text-walk');
            if (walkEl) {
                walkEl.innerHTML = `${today.y}<span class="unit">年</span>${today.m}<span class="unit">月</span>${today.d}<span class="unit">日</span>`;
            }

            // 4. 他（text-other） 
            const otherEl = document.getElementById('text-other');
            if (otherEl) {
                otherEl.innerHTML = `${today.y}<span class="unit">年</span>${today.m}<span class="unit">月</span>${today.d}<span class="unit">日</span>`;
            }
        });

        // 1. 要素の取得
        const input1 = document.getElementById('input-1');
        const input2 = document.getElementById('input-2');
        const input3 = document.getElementById('input-3');
        const out1 = document.getElementById('text-out-1');
        const out2 = document.getElementById('text-out-2');
        const out3 = document.getElementById('text-out-3');

        const imageUpload = document.getElementById('image-upload');
        const uploadedImg = document.getElementById('uploaded-image');
        const hSlider = document.getElementById('h-slider');
        const vSlider = document.getElementById('v-slider');
        const sizeSlider = document.getElementById('size-slider');
        const checkboxes = document.querySelectorAll('.preset-check');
        const lineInputs = document.querySelectorAll('.line-input');

        // 2. テキスト反映（空の状態から入力できるように修正）
        input1.addEventListener('input', () => { out1.innerText = input1.value; });

        input2.addEventListener('input', () => {
            let val = input2.value.replace(/\D/g, '');
            if (val.length === 8) {
                const y = val.substring(0, 4);
                const m = val.substring(4, 6);
                const d = val.substring(6, 8);
                out2.innerHTML = `${y}<span class="unit">年</span>${m}<span class="unit">月</span>${d}<span class="unit">日生</span>`;
            } else {
                out2.innerText = val;
            }
        });

        // 3. テキスト反映（チェックボックス or 自由文）
        function updateLicenseText() {
            let selectedPresets = [];
            
            //3-1. チェックされた定型文を取得
            checkboxes.forEach(cb => {
                if (cb.checked) selectedPresets.push(cb.value);
            });

            // 3-2. チェックボックスの数に応じて自由入力欄の有効/無効を切り替え
            // 定型文で埋まった行以降のみ入力可能にする
            lineInputs.forEach((input, index) => {
                if (index < selectedPresets.length) {
                    input.disabled = true;
                    input.style.backgroundColor = "#eee";
                    input.value = ""; // 無効化されたら中身を消す
                } else {
                    input.disabled = false;
                    input.style.backgroundColor = "#fff";
                }
            });

            // 3-3. 表示用の配列を作成（定型文 + 自由入力）
            let finalLines = [...selectedPresets];
            lineInputs.forEach((input) => {
                if (!input.disabled && input.value !== "") {
                    finalLines.push(input.value);
                }
            });

            // 3-4. 最大4行でカットして表示
            out3.innerText = finalLines.slice(0, 4).join('\n');
        }

        // チェックボックスのイベント設定
        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('.preset-check:checked').length;
                if (checkedCount > 4) {
                    cb.checked = false; // 4つを超えたらチェックさせない
                    alert("お約束は最大4つまでです。");
                }
                updateLicenseText();
            });
        });

        // 自由入力欄のイベント設定
        lineInputs.forEach(input => {
            input.addEventListener('input', updateLicenseText);
        });

        // 4. 画像のスタイル更新（見切れ防止ロジック）
        function updateImageStyle() {
            const scale = sizeSlider.value / 100;
            const x = hSlider.value;
            const y = vSlider.value;
            
            // 見切れを防ぐため、widthを直接操作するように変更
            uploadedImg.style.height = (100 * scale) + "%";
            uploadedImg.style.left = `calc(50% + ${x}px)`;
            uploadedImg.style.top = `calc(50% + ${y}px)`;
            uploadedImg.style.transform = "translate(-50%, -50%)";
        }

        // 5. 画像アップロードイベント
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedImg.src = event.target.result;
                    uploadedImg.style.display = 'block';
                    // 読み込み完了後にスタイルを適用
                    setTimeout(updateImageStyle, 50);
                };
                reader.readAsDataURL(file);
            }
        });

        [hSlider, vSlider, sizeSlider].forEach(slider => {
            slider.addEventListener('input', updateImageStyle);
        });

        // 6. 保存処理（html-to-image版）
        document.getElementById('download-btn').addEventListener('click', function() {
            const target = document.getElementById('canvas-container');
            const frame = document.getElementById('photo-frame');
            
            // 保存時のみ枠線を消す
            const originalBorder = frame.style.border;
            frame.style.border = "none";

            // htmlToImageが読み込まれているかチェック
            if (typeof htmlToImage === 'undefined') {
                alert("ライブラリが読み込まれていません。head内のスクリプトタグを確認してください。");
                frame.style.border = originalBorder;
                return;
            }

            htmlToImage.toPng(target, {
                width: 800,
                height: 500,
                pixelRatio: 2
            })
            .then(function (dataUrl) {
                const link = document.createElement('a');
                link.download = 'my-license-card.png';
                link.href = dataUrl;
                link.click();
                frame.style.border = originalBorder;
            })
            .catch(function (error) {
                console.error('保存エラー:', error);
                alert("画像の保存に失敗しました。");
                frame.style.border = originalBorder;
            });
        });
    </script>

<!--/////-->

    <script src="./script/click.js"></script>
    <script src="./script/stalker.js"></script>
    <script src="./script/slideshow.js"></script>
    <script src="./script/CanvasAnimation.js"></script>
    <script src="./script/import.js"></script>
    <!--<script src="./script/first.js" defer></script>-->
    <script src="./script/clipboad.js"></script>
    <script src="./script/load.js"></script>
    <script src="./script/sidebar.js"></script>
</div>

    <div class="hero-container2">
        <div class="environment"></div>
        <div class="hero glitch layers fs-b5 fs-h8 text-shadow-2b" data-text="© 小鳥Lab研究所"><span class="color-000">© 小鳥Lab研究所</span></div>
    </div>
</body>

</html>